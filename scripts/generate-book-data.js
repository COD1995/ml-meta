#!/usr/bin/env node
/* ---------------------------------------------------------------
   generate-book-data.js
   ---------------------------------------------------------------
   Creates  books/<book>/chapters/book-data.js   for every book
   so the browser can render the chapter list without server code.
   ------------------------------------------------------------- */
const fs = require("fs");
const path = require("path");

/* ─── 1. Discover every /books/<slug>/chapters directory ─────────── */
const booksRoot = path.join(__dirname, "..", "books");
const bookSlugs = fs
  .readdirSync(booksRoot)
  .filter((dir) => fs.statSync(path.join(booksRoot, dir)).isDirectory());

bookSlugs.forEach(buildForBook);
console.log("✓ book-data.js regenerated for", bookSlugs.length, "book(s)");

/* ───────────────────────── helpers ──────────────────────────────── */
function buildForBook(slug) {
  const chaptersDir = path.join(booksRoot, slug, "chapters");
  if (!fs.existsSync(chaptersDir)) return;

  /* gather *.html files (ignore index.html) */
  const chapters = fs
    .readdirSync(chaptersDir)
    .filter((f) => f.endsWith(".html") && f !== "index.html")
    .map((f) => ({
      href: f,
      title: fileNameToTitle(f),
    }))
    .sort((a, b) =>
      a.title.localeCompare(b.title, undefined, { numeric: true })
    );

  const bookData = {
    title: toTitle(slug), // Algorithms (→ Algorithms)
    chapters,
  };

  const outPath = path.join(chaptersDir, "book-data.js");
  fs.writeFileSync(
    outPath,
    `/* Auto‑generated by scripts/generate-book-data.js – DO NOT EDIT */
window.BOOK_DATA = ${JSON.stringify(bookData, null, 2)};`
  );
}

/* convert "04-paths-in-graphs.html" → "4. Paths In Graphs"          */
function fileNameToTitle(filename) {
  const name = filename.replace(/\.html$/i, "");
  const parts = name.split("-");
  const num = parts.shift();
  const words = parts.map((w) => w[0].toUpperCase() + w.slice(1));
  return `${parseInt(num, 10)}. ${words.join(" ")}`;
}

/* convert "pattern-classification" → "Pattern Classification"       */
function toTitle(slug) {
  return slug.replace(/-/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
}
